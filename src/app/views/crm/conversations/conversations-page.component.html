<c-row>
  <c-col xl="6">
    <c-card class="mb-4">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Conversaciones</strong>
          <small class="text-body-secondary ms-2">Total: {{ total }}</small>
        </div>
        <button cButton color="primary" type="button" (click)="refresh()" [disabled]="isLoading">
          {{ isLoading ? 'Cargando...' : 'Refrescar' }}
        </button>
      </c-card-header>
      <c-card-body>
        @if (error) {
          <c-alert color="danger" class="mb-3">{{ error }}</c-alert>
        }

        <table cTable [striped]="true">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Asunto</th>
              <th scope="col">Ultimo mensaje</th>
              <th scope="col">No leidos</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (c of conversations; track c.id) {
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.subject ?? '' }}</td>
                <td>{{ c.last_message ?? '' }}</td>
                <td>{{ c.unread_count ?? 0 }}</td>
                <td class="d-flex flex-wrap gap-2">
                  <button cButton color="info" size="sm" type="button" (click)="openConversation(c)">
                    Ver
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="5" class="text-center text-body-secondary">Sin datos</td>
              </tr>
            }
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>

  <c-col xl="6">
    <c-card class="mb-4">
      <c-card-header>
        <strong>Nueva conversacion</strong>
      </c-card-header>
      <c-card-body>
        @if (submitError) {
          <c-alert color="danger" class="mb-3">{{ submitError }}</c-alert>
        }

        <form cForm [formGroup]="form" (ngSubmit)="createConversation()">
          <c-row class="g-3">
            <c-col md="12">
              <label cLabel for="subject">Asunto</label>
              <input id="subject" cFormControl type="text" formControlName="subject" />
            </c-col>
            <c-col md="12">
              <label cLabel for="participant_user_ids">Participantes (IDs separados por coma)</label>
              <input id="participant_user_ids" cFormControl type="text" formControlName="participant_user_ids" />
              @if (form.controls.participant_user_ids.touched && form.controls.participant_user_ids.invalid) {
                <div class="text-danger small mt-1">Participantes requeridos.</div>
              }
            </c-col>
            <c-col md="12">
              <label cLabel for="first_message">Primer mensaje</label>
              <textarea id="first_message" cFormControl rows="3" formControlName="first_message"></textarea>
              @if (form.controls.first_message.touched && form.controls.first_message.invalid) {
                <div class="text-danger small mt-1">Mensaje requerido.</div>
              }
            </c-col>
            <c-col xs="12">
              <button cButton color="success" type="submit">Crear</button>
            </c-col>
          </c-row>
        </form>
      </c-card-body>
    </c-card>
  </c-col>

  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header>
        <strong>Mensajes</strong>
        @if (selectedId) {
          <small class="text-body-secondary ms-2">Conversacion #{{ selectedId }}</small>
        }
      </c-card-header>
      <c-card-body>
        @if (messageError) {
          <c-alert color="danger" class="mb-3">{{ messageError }}</c-alert>
        }
        @if (isLoadingDetail) {
          <div class="text-body-secondary">Cargando mensajes...</div>
        } @else {
          @if (selectedConversation) {
            <div class="mb-3">
              <div class="small text-body-secondary">Participantes:</div>
              <div class="small">
                @for (p of selectedConversation.participants ?? []; track p.id) {
                  <span class="me-2">{{ p.name ?? p.email ?? p.id }} ({{ p.role ?? '' }})</span>
                }
              </div>
            </div>
          }

          <div class="mb-3">
            @for (m of messages; track m.id) {
              <div class="mb-2">
                <div class="small text-body-secondary">
                  {{ m.sender_name ?? m.sender_user_id }} - {{ m.created_at ?? '' }}
                </div>
                <div>{{ m.body }}</div>
              </div>
            } @empty {
              <div class="text-body-secondary">Sin mensajes</div>
            }
          </div>

          <form cForm [formGroup]="messageForm" (ngSubmit)="sendMessage()">
            <c-row class="g-2">
              <c-col md="10">
                <input id="body" cFormControl type="text" formControlName="body" placeholder="Escribe un mensaje" />
              </c-col>
              <c-col md="2" class="d-grid">
                <button cButton color="primary" type="submit" [disabled]="selectedId === null">Enviar</button>
              </c-col>
            </c-row>
          </form>
        }
      </c-card-body>
    </c-card>
  </c-col>
</c-row>
