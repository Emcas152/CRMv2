<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header class="patients-header align-items-center">
        <div class="patients-title">
          <h2 class="mb-0">Pacientes</h2>
          <div class="text-body-secondary small">Total: {{ total }}</div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <form [formGroup]="filterForm" (ngSubmit)="refresh()" class="d-flex gap-2 align-items-center">
            <input class="form-control form-control-sm" placeholder="Buscar paciente" formControlName="search" />
            <button cButton color="primary" size="sm" type="submit" [disabled]="isLoading">{{ isLoading ? 'Cargando…' : 'Buscar' }}</button>
          </form>
          <button cButton color="warning" class="btn-lg rounded-pill" type="button" (click)="startCreate()" [disabled]="isSaving || isLoading">Nuevo Paciente</button>
        </div>
      </c-card-header>

      <c-card-body>
        <c-alert *ngIf="error" color="danger" class="mb-3">{{ error }}</c-alert>
        <c-alert *ngIf="submitError" color="danger" class="mb-3">{{ submitError }}</c-alert>
        <c-alert *ngIf="actionError" color="danger" class="mb-3">{{ actionError }}</c-alert>
        <c-alert *ngIf="actionInfo" color="success" class="mb-3">{{ actionInfo }}</c-alert>

        <div *ngIf="qrResult" class="mb-3">
          <div class="small text-body-secondary">QR paciente #{{ qrResult.patient_id }}</div>
          <div *ngIf="qrResult.qr_url" class="small">URL: <a [href]="qrResult.qr_url" target="_blank" rel="noreferrer">{{ qrResult.qr_url }}</a></div>
          <pre class="small mb-0">{{ qrResult.qr_code }}</pre>
        </div>

        <!-- Create / Edit form -->
        <form cForm class="mb-4" [formGroup]="form" (ngSubmit)="save()">
          <div class="mb-2">
            <strong>{{ editingId === null ? 'Crear paciente' : 'Editar paciente #' + editingId }}</strong>
          </div>
          <c-row class="g-3">
            <c-col md="4">
              <label cLabel for="name">Nombre</label>
              <input id="name" cFormControl type="text" formControlName="name" />
              <div *ngIf="form.controls.name.touched && form.controls.name.invalid" class="text-danger small mt-1">Nombre requerido.</div>
            </c-col>
            <c-col md="4">
              <label cLabel for="email">Email</label>
              <input id="email" cFormControl type="email" formControlName="email" />
              <div *ngIf="form.controls.email.touched && form.controls.email.invalid" class="text-danger small mt-1">Email válido requerido.</div>
            </c-col>
            <c-col md="4">
              <label cLabel for="phone">Teléfono</label>
              <input id="phone" cFormControl type="text" formControlName="phone" />
            </c-col>

            <c-col md="3">
              <label cLabel for="birthday">Fecha de nacimiento</label>
              <input id="birthday" cFormControl type="date" formControlName="birthday" />
            </c-col>
            <c-col md="6">
              <label cLabel for="address">Dirección</label>
              <input id="address" cFormControl type="text" formControlName="address" />
            </c-col>
            <c-col md="3">
              <label cLabel for="nit">NIT</label>
              <input id="nit" cFormControl type="text" formControlName="nit" />
            </c-col>

            <c-col xs="12" class="d-flex gap-2">
              <button cButton color="success" type="submit" [disabled]="isSaving">{{ isSaving ? 'Guardando…' : (editingId === null ? 'Crear' : 'Guardar') }}</button>
              <button *ngIf="editingId !== null" cButton color="secondary" type="button" (click)="cancelEdit()" [disabled]="isSaving">Cancelar</button>
            </c-col>
          </c-row>
        </form>

        <!-- Patients table -->
        <table cTable [striped]="true">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Nombre</th>
              <th scope="col">Email</th>
              <th scope="col">Teléfono</th>
              <th scope="col">NIT</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="patients.length; else empty">
              <tr *ngFor="let p of patients; trackBy: trackByPatient">
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.email }}</td>
                <td>{{ p.phone ?? '' }}</td>
                <td>{{ p.nit ?? '' }}</td>
                <td class="d-flex flex-wrap gap-2 align-items-center">
                  <button cButton color="secondary" size="sm" type="button" (click)="startEdit(p)">Editar</button>
                  <button cButton color="danger" size="sm" type="button" (click)="delete(p)">Eliminar</button>
                  <button cButton color="info" size="sm" type="button" (click)="showQr(p)" [disabled]="actingId === p.id">QR</button>

                  <input class="form-control form-control-sm" style="width: 110px" type="number" min="1" placeholder="Puntos"
                    [value]="loyaltyPointsById[p.id] ?? ''" (input)="setLoyaltyPoints(p, $any($event.target).value)" />
                  <button cButton color="success" size="sm" type="button" (click)="loyaltyAdd(p)" [disabled]="actingId === p.id">+Pts</button>
                  <button cButton color="warning" size="sm" type="button" (click)="loyaltyRedeem(p)" [disabled]="actingId === p.id">-Pts</button>

                  <input class="form-control form-control-sm" style="width: 170px" type="file" accept="image/*" (change)="uploadPhoto(p, $event, 'before')" [disabled]="actingId === p.id" title="Subir antes" />
                  <input class="form-control form-control-sm" style="width: 170px" type="file" accept="image/*" (change)="uploadPhoto(p, $event, 'after')" [disabled]="actingId === p.id" title="Subir después" />

                  <span *ngIf="rowStatusById[p.id]" class="small text-body-secondary align-self-center">{{ rowStatusById[p.id] }}</span>
                </td>
              </tr>
            </ng-container>
            <ng-template #empty>
              <tr>
                <td colspan="6" class="text-center text-body-secondary">Sin datos</td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>
