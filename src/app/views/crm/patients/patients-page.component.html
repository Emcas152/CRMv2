<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Pacientes</strong>
          <small class="text-body-secondary ms-2">Total: {{ total }}</small>
        </div>
        <div class="d-flex gap-2">
          <button cButton color="secondary" type="button" (click)="startCreate()" [disabled]="isSaving || isLoading">
            Nuevo
          </button>
          <button cButton color="primary" type="button" (click)="refresh()" [disabled]="isLoading">
            {{ isLoading ? 'Cargando…' : 'Refrescar' }}
          </button>
        </div>
      </c-card-header>
      <c-card-body>
        @if (error) {
          <c-alert color="danger" class="mb-3">{{ error }}</c-alert>
        }

        @if (submitError) {
          <c-alert color="danger" class="mb-3">{{ submitError }}</c-alert>
        }

        @if (actionError) {
          <c-alert color="danger" class="mb-3">{{ actionError }}</c-alert>
        }

        @if (actionInfo) {
          <c-alert color="success" class="mb-3">{{ actionInfo }}</c-alert>
        }

        @if (qrResult) {
          <div class="mb-3">
            <div class="small text-body-secondary">QR paciente #{{ qrResult.patient_id }}</div>
            @if (qrResult.qr_url) {
              <div class="small">URL: <a [href]="qrResult.qr_url" target="_blank" rel="noreferrer">{{ qrResult.qr_url }}</a></div>
            }
            <pre class="small mb-0">{{ qrResult.qr_code }}</pre>
          </div>
        }

        <form cForm class="mb-4" [formGroup]="filterForm" (ngSubmit)="refresh()">
          <div class="mb-2"><strong>Filtros</strong></div>
          <c-row class="g-3">
            <c-col md="4">
              <label cLabel for="f_search">Buscar</label>
              <input id="f_search" cFormControl type="text" formControlName="search" />
            </c-col>
            <c-col md="2">
              <label cLabel for="f_birthday_month">Mes de nacimiento</label>
              <input id="f_birthday_month" cFormControl type="text" formControlName="birthday_month" placeholder="1-12" />
            </c-col>
            <c-col md="2">
              <label cLabel for="f_date_from">Desde</label>
              <input id="f_date_from" cFormControl type="date" formControlName="date_from" />
            </c-col>
            <c-col md="2">
              <label cLabel for="f_date_to">Hasta</label>
              <input id="f_date_to" cFormControl type="date" formControlName="date_to" />
            </c-col>
            <c-col md="2">
              <label cLabel for="f_per_page">Por página</label>
              <input id="f_per_page" cFormControl type="number" min="1" max="200" formControlName="per_page" />
            </c-col>
            <c-col xs="12" class="d-flex gap-2">
              <button cButton color="primary" type="submit" [disabled]="isLoading">
                {{ isLoading ? 'Cargando…' : 'Aplicar' }}
              </button>
              <button cButton color="secondary" type="button" (click)="prevPage()" [disabled]="isLoading">
                Anterior
              </button>
              <button cButton color="secondary" type="button" (click)="nextPage()" [disabled]="isLoading">
                Siguiente
              </button>
              <div class="text-body-secondary small align-self-center">Página: {{ filterForm.controls.page.value }}</div>
            </c-col>
          </c-row>
        </form>

        <form cForm class="mb-4" [formGroup]="form" (ngSubmit)="save()">
          <div class="mb-2">
            <strong>{{ editingId === null ? 'Crear paciente' : 'Editar paciente #' + editingId }}</strong>
          </div>
          <c-row class="g-3">
            <c-col md="4">
              <label cLabel for="name">Nombre</label>
              <input id="name" cFormControl type="text" formControlName="name" />
              @if (form.controls.name.touched && form.controls.name.invalid) {
                <div class="text-danger small mt-1">Nombre requerido.</div>
              }
            </c-col>
            <c-col md="4">
              <label cLabel for="email">Email</label>
              <input id="email" cFormControl type="email" formControlName="email" />
              @if (form.controls.email.touched && form.controls.email.invalid) {
                <div class="text-danger small mt-1">Email válido requerido.</div>
              }
            </c-col>
            <c-col md="4">
              <label cLabel for="phone">Teléfono</label>
              <input id="phone" cFormControl type="text" formControlName="phone" />
            </c-col>

            <c-col md="3">
              <label cLabel for="birthday">Fecha de nacimiento</label>
              <input id="birthday" cFormControl type="date" formControlName="birthday" />
            </c-col>
            <c-col md="6">
              <label cLabel for="address">Dirección</label>
              <input id="address" cFormControl type="text" formControlName="address" />
            </c-col>
            <c-col md="3">
              <label cLabel for="nit">NIT</label>
              <input id="nit" cFormControl type="text" formControlName="nit" />
            </c-col>

            <c-col xs="12" class="d-flex gap-2">
              <button cButton color="success" type="submit" [disabled]="isSaving">
                {{ isSaving ? 'Guardando…' : (editingId === null ? 'Crear' : 'Guardar') }}
              </button>
              @if (editingId !== null) {
                <button cButton color="secondary" type="button" (click)="cancelEdit()" [disabled]="isSaving">
                  Cancelar
                </button>
              }
            </c-col>
          </c-row>
        </form>

        <table cTable [striped]="true">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Nombre</th>
              <th scope="col">Email</th>
              <th scope="col">Teléfono</th>
              <th scope="col">NIT</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (p of patients; track p.id) {
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.email }}</td>
                <td>{{ p.phone ?? '' }}</td>
                <td>{{ p.nit ?? '' }}</td>
                <td class="d-flex flex-wrap gap-2">
                  <button cButton color="secondary" size="sm" type="button" (click)="startEdit(p)">Editar</button>
                  <button cButton color="danger" size="sm" type="button" (click)="delete(p)">Eliminar</button>
                  <button cButton color="info" size="sm" type="button" (click)="showQr(p)" [disabled]="actingId === p.id">QR</button>

                  <input
                    class="form-control form-control-sm"
                    style="width: 110px"
                    type="number"
                    min="1"
                    placeholder="Puntos"
                    [value]="loyaltyPointsById[p.id] ?? ''"
                    (input)="setLoyaltyPoints(p, $any($event.target).value)"
                  />
                  <button cButton color="success" size="sm" type="button" (click)="loyaltyAdd(p)" [disabled]="actingId === p.id">
                    +Pts
                  </button>
                  <button cButton color="warning" size="sm" type="button" (click)="loyaltyRedeem(p)" [disabled]="actingId === p.id">
                    -Pts
                  </button>

                  <input
                    class="form-control form-control-sm"
                    style="width: 170px"
                    type="file"
                    accept="image/*"
                    (change)="uploadPhoto(p, $event, 'before')"
                    [disabled]="actingId === p.id"
                    title="Subir antes"
                  />
                  <input
                    class="form-control form-control-sm"
                    style="width: 170px"
                    type="file"
                    accept="image/*"
                    (change)="uploadPhoto(p, $event, 'after')"
                    [disabled]="actingId === p.id"
                    title="Subir después"
                  />

                  @if (rowStatusById[p.id]) {
                    <span class="small text-body-secondary align-self-center">{{ rowStatusById[p.id] }}</span>
                  }
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="text-center text-body-secondary">Sin datos</td>
              </tr>
            }
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>
