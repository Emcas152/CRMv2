<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Gesti√≥n de Citas</strong>
          <small class="text-body-secondary ms-2" *ngIf="!isPatient">Total: {{ total }}</small>
        </div>
        <div class="d-flex gap-2">
          <ng-container *ngIf="!isPatient">
            <button cButton color="secondary" type="button" (click)="startCreate()" [disabled]="isSaving || isLoading">
              Nueva Cita
            </button>
          </ng-container>
          <button cButton color="primary" type="button" (click)="refresh()" [disabled]="isLoading">
            {{ isLoading ? 'Cargando‚Ä¶' : 'Refrescar' }}
          </button>
        </div>
      </c-card-header>
      <c-card-body>
        <c-alert *ngIf="error && !isPatient" color="danger" class="mb-3">{{ error }}</c-alert>
        <c-alert *ngIf="submitError" color="danger" class="mb-3">{{ submitError }}</c-alert>
        <c-alert *ngIf="actionError" color="danger" class="mb-3">{{ actionError }}</c-alert>

        <!-- Info for patients -->
        <c-alert *ngIf="isPatient" color="info" class="mb-3">
          Selecciona una fecha en el calendario para ver los horarios disponibles y solicitar una cita.
        </c-alert>

        <div class="d-flex gap-3">
          <!-- Calendar Grid -->
          <div class="flex-grow-1 appointments-calendar">
            <!-- Calendar Header -->
            <div class="calendar-header">
              <div class="nav-buttons">
                <button cButton color="light" size="sm" type="button" (click)="prevMonth()">
                  &lt;
                </button>
                <button cButton color="light" size="sm" type="button" (click)="goToToday()">
                  Hoy
                </button>
                <button cButton color="light" size="sm" type="button" (click)="nextMonth()">
                  &gt;
                </button>
              </div>
              <div class="month-title">{{ currentMonthYear }}</div>
              <div></div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
              <!-- Weekday Headers -->
              <div *ngFor="let day of weekDays" class="calendar-weekday">
                {{ day }}
              </div>

              <!-- Calendar Days -->
              <div *ngFor="let day of calendarDays"
                   class="calendar-day"
                   [class.other-month]="!day.isCurrentMonth"
                   [class.today]="day.isToday"
                   [class.selected]="selectedDate === day.dateStr"
                   (click)="onDayClick(day)">
                <span class="day-number">{{ day.dayNumber }}</span>
                <div class="day-appointments">
                  <div *ngFor="let appt of getVisibleAppointments(day)"
                       class="appointment-chip"
                       [class.status-pending]="appt.status === 'pending'"
                       [class.status-confirmed]="appt.status === 'confirmed'"
                       [class.status-completed]="appt.status === 'completed'"
                       [class.status-cancelled]="appt.status === 'cancelled'"
                       [class.my-appointment]="isMyAppointment(appt)"
                       [class.occupied-slot]="isPatient && !isMyAppointment(appt)"
                       (click)="onAppointmentClick(appt, $event)"
                       [title]="isPatient && !isMyAppointment(appt) ? 'Ocupado' : (appt.patient_name || appt.service)">
                    {{ getAppointmentDisplay(appt) }}
                  </div>
                  <div *ngIf="getHiddenCount(day) > 0" class="more-appointments">
                    +{{ getHiddenCount(day) }} m√°s
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Time Slots Panel -->
          <div style="width: 340px;">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ selectedDate || 'Selecciona una fecha' }}</strong>
                <span *ngIf="selectedDay?.appointments?.length" class="badge bg-primary">
                  {{ selectedDay?.appointments?.length }} cita(s)
                </span>
              </div>

              <div *ngIf="selectedDate" class="time-slots-panel">
                <div *ngIf="!canViewOccupiedForDate" class="mb-2 text-warning small">
                  No podemos verificar todos los horarios. La disponibilidad se validar√° al enviar.
                </div>

                <div class="mb-2 small text-body-secondary">Horarios disponibles:</div>

                <div *ngFor="let slot of daySlots">
                  <button type="button"
                          class="slot-button"
                          [class.available]="slot.available"
                          [class.occupied]="!slot.available"
                          [disabled]="!slot.available && isPatient"
                          (click)="slot.available && isPatient ? requestSlot(selectedDate!, slot.time) : (!slot.available && !isPatient && slot.appointment ? onAppointmentClick(slot.appointment, $event) : null)">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="slot-time">{{ slot.time }}</span>
                      <span *ngIf="slot.available" class="badge bg-success">Disponible</span>
                      <span *ngIf="!slot.available" class="badge bg-secondary">Ocupado</span>
                    </div>
                    <div *ngIf="!slot.available && slot.appointment" class="slot-info">
                      <span *ngIf="!isPatient" class="slot-patient">
                        {{ slot.appointment.patient_name || 'Paciente #' + slot.appointment.patient_id }}
                      </span>
                      <span *ngIf="isPatient && slot.appointment.patient_id === patientIdForFilter" class="slot-patient">
                        Tu cita - {{ slot.appointment.service }}
                      </span>
                    </div>
                    <div *ngIf="slot.available && isPatient" class="slot-info">
                      Click para reservar
                    </div>
                  </button>
                </div>
              </div>

              <div *ngIf="!selectedDate" class="text-body-secondary small text-center py-4">
                Haz clic en una fecha del calendario para ver los horarios disponibles.
              </div>
            </div>

            <!-- Form for Staff to create/edit appointments -->
            <div *ngIf="!isPatient && (editingId !== null || form.controls.patient_id.value)" class="card p-3 mt-3">
              <div class="mb-2">
                <strong>{{ editingId ? 'Editar Cita #' + editingId : 'Nueva Cita' }}</strong>
              </div>
              <form [formGroup]="form" (ngSubmit)="save()">
                <div class="mb-2">
                  <label class="form-label small">Paciente</label>
                  <select class="form-select form-select-sm" formControlName="patient_id">
                    <option [value]="0">-- Seleccionar --</option>
                    <option *ngFor="let p of patients; trackBy: trackByPatient" [value]="p.id">
                      {{ p.name }}
                    </option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Fecha</label>
                  <input type="date" class="form-control form-control-sm" formControlName="appointment_date" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Hora</label>
                  <input type="time" class="form-control form-control-sm" formControlName="appointment_time" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Servicio</label>
                  <input type="text" class="form-control form-control-sm" formControlName="service" />
                </div>
                <div class="mb-2">
                  <label class="form-label small">Estado</label>
                  <select class="form-select form-select-sm" formControlName="status">
                    <option *ngFor="let s of statuses" [value]="s">{{ statusLabels[s] }}</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Notas</label>
                  <textarea class="form-control form-control-sm" rows="2" formControlName="notes"></textarea>
                </div>
                <div class="d-flex gap-2 justify-content-end">
                  <button cButton color="secondary" size="sm" type="button" (click)="cancelEdit()">Cancelar</button>
                  <button cButton color="primary" size="sm" type="submit" [disabled]="isSaving || form.invalid">
                    {{ isSaving ? 'Guardando‚Ä¶' : (editingId ? 'Actualizar' : 'Crear') }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Appointments Table for Staff -->
        <div *ngIf="!isPatient && items.length > 0" class="mt-4">
          <h6>Listado de Citas</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Paciente</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Servicio</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let a of items; trackBy: trackByAppointment">
                  <td>{{ a.id }}</td>
                  <td>{{ a.patient_name || 'Paciente #' + a.patient_id }}</td>
                  <td>{{ a.appointment_date }}</td>
                  <td>{{ a.appointment_time }}</td>
                  <td>{{ a.service }}</td>
                  <td>
                    <span class="badge"
                          [class.bg-warning]="a.status === 'pending'"
                          [class.bg-primary]="a.status === 'confirmed'"
                          [class.bg-success]="a.status === 'completed'"
                          [class.bg-secondary]="a.status === 'cancelled'">
                      {{ a.status ? statusLabels[a.status] : a.status }}
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button cButton color="info" size="sm" type="button" (click)="startEdit(a)" title="Editar">
                        ‚úèÔ∏è
                      </button>
                      <button cButton color="success" size="sm" type="button" (click)="updateStatus(a, 'confirmed')" [disabled]="actingId !== null || a.status === 'confirmed'" title="Confirmar">
                        ‚úì
                      </button>
                      <button cButton color="warning" size="sm" type="button" (click)="generateReminder(a)" [disabled]="actingId !== null" title="Generar recordatorio">
                        üîî
                      </button>
                      <button cButton color="danger" size="sm" type="button" (click)="delete(a)" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </div>
                    <small *ngIf="getRowStatus(a)" class="d-block text-muted mt-1">{{ getRowStatus(a) }}</small>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-body-secondary">P√°gina {{ filterForm.controls.page.value }} de {{ (total / (filterForm.controls.per_page.value || 20)) | number:'1.0-0' }}</small>
            <div class="btn-group btn-group-sm">
              <button cButton color="light" size="sm" type="button" (click)="prevPage()" [disabled]="isLoading || filterForm.controls.page.value <= 1">Anterior</button>
              <button cButton color="light" size="sm" type="button" (click)="nextPage()" [disabled]="isLoading">Siguiente</button>
            </div>
          </div>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Request Modal for Patients -->
<div *ngIf="showRequestModal" class="modal-backdrop-custom">
  <div class="modal-content-custom card p-4" style="width: 480px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <strong>Solicitar Cita</strong>
      <button cButton color="light" size="sm" type="button" (click)="cancelRequest()">‚úï</button>
    </div>
    <div class="mb-3">
      <div class="d-flex gap-4">
        <div>
          <small class="text-body-secondary">Fecha</small>
          <div class="fw-bold">{{ requestDraft.date }}</div>
        </div>
        <div>
          <small class="text-body-secondary">Hora</small>
          <div class="fw-bold">{{ requestDraft.time }}</div>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label small">Motivo de la cita (opcional)</label>
      <textarea class="form-control" rows="3" [(ngModel)]="requestDraft.notes" placeholder="Describe brevemente el motivo de tu consulta..."></textarea>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button cButton color="secondary" type="button" (click)="cancelRequest()">Cancelar</button>
      <button cButton color="success" type="button" (click)="confirmRequest()" [disabled]="isSaving">
        {{ isSaving ? 'Enviando‚Ä¶' : 'Confirmar Solicitud' }}
      </button>
    </div>
  </div>
</div>

<!-- Reminder Modal for Staff -->
<div *ngIf="showReminderModal" class="modal-backdrop-custom">
  <div class="modal-content-custom card p-4" style="width: 600px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <strong>Recordatorio de Cita</strong>
      <button cButton color="light" size="sm" type="button" (click)="showReminderModal = false; reminderAppointment = null">‚úï</button>
    </div>
    <div class="mb-3 p-2 bg-light rounded">
      <div class="small text-body-secondary">Paciente</div>
      <div class="fw-bold">{{ reminderAppointment?.patient_name || 'Paciente #' + reminderAppointment?.patient_id }}</div>
      <div class="d-flex gap-4 mt-2">
        <div>
          <small class="text-body-secondary">Fecha</small>
          <div>{{ reminderAppointment?.appointment_date }}</div>
        </div>
        <div>
          <small class="text-body-secondary">Hora</small>
          <div>{{ reminderAppointment?.appointment_time }}</div>
        </div>
        <div>
          <small class="text-body-secondary">Servicio</small>
          <div>{{ reminderAppointment?.service }}</div>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label small">Texto del recordatorio</label>
      <textarea class="form-control" rows="6" [(ngModel)]="reminderDraft" placeholder="Escribe o genera un recordatorio con IA..."></textarea>
    </div>
    <div class="d-flex justify-content-between">
      <div class="d-flex gap-2">
        <button cButton color="light" size="sm" type="button" (click)="copyReminderToClipboard()">üìã Copiar</button>
        <button cButton color="warning" size="sm" type="button" (click)="reminderAppointment && generateReminder(reminderAppointment)" [disabled]="actingId !== null">
          ü§ñ Generar con IA
        </button>
      </div>
      <div class="d-flex gap-2">
        <button cButton color="secondary" type="button" (click)="showReminderModal = false">Cerrar</button>
        <button cButton color="success" type="button" (click)="saveReminderAndSendWhatsapp()" [disabled]="isSavingReminder">
          üì± WhatsApp
        </button>
        <button cButton color="info" type="button" (click)="saveReminderAndSendEmail()" [disabled]="isSavingReminder">
          ‚úâÔ∏è Email
        </button>
      </div>
    </div>
  </div>
</div>
