<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Tareas</strong>
          <small class="text-body-secondary ms-2">Total: {{ total }}</small>
        </div>
        <div class="d-flex gap-2">
          <button cButton color="secondary" type="button" (click)="startCreate()" [disabled]="isSaving || isLoading">
            Nuevo
          </button>
          <button cButton color="primary" type="button" (click)="refresh()" [disabled]="isLoading">
            {{ isLoading ? 'Cargando...' : 'Refrescar' }}
          </button>
        </div>
      </c-card-header>
      <c-card-body>
        @if (error) {
          <c-alert color="danger" class="mb-3">{{ error }}</c-alert>
        }

        @if (submitError) {
          <c-alert color="danger" class="mb-3">{{ submitError }}</c-alert>
        }

        <form cForm class="mb-4" [formGroup]="filterForm" (ngSubmit)="refresh()">
          <div class="mb-2"><strong>Filtros</strong></div>
          <c-row class="g-3">
            <c-col md="4">
              <label cLabel for="f_status">Estado</label>
              <select id="f_status" cSelect formControlName="status">
                <option value="">--</option>
                @for (s of statuses; track s) {
                  <option [value]="s">{{ s }}</option>
                }
              </select>
            </c-col>
            <c-col md="4">
              <label cLabel for="f_assigned">Asignado a (user_id)</label>
              <input id="f_assigned" cFormControl type="number" min="0" formControlName="assigned_to_user_id" />
            </c-col>
            <c-col md="4">
              <label cLabel for="f_patient">Paciente (patient_id)</label>
              <input id="f_patient" cFormControl type="number" min="0" formControlName="related_patient_id" />
            </c-col>
            <c-col xs="12" class="d-flex gap-2">
              <button cButton color="primary" type="submit" [disabled]="isLoading">
                {{ isLoading ? 'Cargando...' : 'Aplicar' }}
              </button>
            </c-col>
          </c-row>
        </form>

        <form cForm class="mb-4" [formGroup]="form" (ngSubmit)="save()">
          <div class="mb-2">
            <strong>{{ editingId === null ? 'Crear tarea' : 'Editar tarea #' + editingId }}</strong>
          </div>
          <c-row class="g-3">
            <c-col md="6">
              <label cLabel for="title">Titulo</label>
              <input id="title" cFormControl type="text" formControlName="title" />
              @if (form.controls.title.touched && form.controls.title.invalid) {
                <div class="text-danger small mt-1">Titulo requerido.</div>
              }
            </c-col>
            <c-col md="6">
              <label cLabel for="due_date">Fecha limite</label>
              <input id="due_date" cFormControl type="date" formControlName="due_date" />
            </c-col>
            <c-col md="12">
              <label cLabel for="description">Descripcion</label>
              <textarea id="description" cFormControl rows="3" formControlName="description"></textarea>
            </c-col>
            <c-col md="4">
              <label cLabel for="status">Estado</label>
              <select id="status" cSelect formControlName="status">
                @for (s of statuses; track s) {
                  <option [value]="s">{{ s }}</option>
                }
              </select>
            </c-col>
            <c-col md="4">
              <label cLabel for="priority">Prioridad</label>
              <select id="priority" cSelect formControlName="priority">
                @for (p of priorities; track p) {
                  <option [value]="p">{{ p }}</option>
                }
              </select>
            </c-col>
            <c-col md="4">
              <label cLabel for="assigned_to_user_id">Asignado a (user_id)</label>
              <input id="assigned_to_user_id" cFormControl type="number" min="0" formControlName="assigned_to_user_id" />
            </c-col>
            <c-col md="4">
              <label cLabel for="related_patient_id">Paciente (patient_id)</label>
              <input id="related_patient_id" cFormControl type="number" min="0" formControlName="related_patient_id" />
            </c-col>
            <c-col xs="12" class="d-flex gap-2">
              <button cButton color="success" type="submit" [disabled]="isSaving">
                {{ isSaving ? 'Guardando...' : (editingId === null ? 'Crear' : 'Guardar') }}
              </button>
              @if (editingId !== null) {
                <button cButton color="secondary" type="button" (click)="cancelEdit()" [disabled]="isSaving">
                  Cancelar
                </button>
              }
            </c-col>
          </c-row>
        </form>

        <table cTable [striped]="true">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Titulo</th>
              <th scope="col">Estado</th>
              <th scope="col">Asignado</th>
              <th scope="col">Paciente</th>
              <th scope="col">Fecha limite</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (t of tasks; track t.id) {
              <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.title }}</td>
                <td>{{ t.status }}</td>
                <td>{{ t.assigned_to_name ?? t.assigned_to_user_id ?? '' }}</td>
                <td>{{ t.patient_name ?? t.related_patient_id ?? '' }}</td>
                <td>{{ t.due_date ?? '' }}</td>
                <td class="d-flex flex-wrap gap-2">
                  <button cButton color="secondary" size="sm" type="button" (click)="startEdit(t)">Editar</button>
                  <button cButton color="danger" size="sm" type="button" (click)="delete(t)">Eliminar</button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="7" class="text-center text-body-secondary">Sin datos</td>
              </tr>
            }
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>
